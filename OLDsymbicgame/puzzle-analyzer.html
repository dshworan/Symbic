<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Puzzle Analyzer</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f0f0f0;
            }
            .controls {
                max-width: 800px;
                margin: 0 auto 20px;
                padding: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: flex;
                gap: 20px;
                align-items: center;
            }
            .control-group {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .control-group label {
                font-weight: bold;
                color: #2c3e50;
            }
            .control-group select {
                padding: 8px;
                border: 1px solid #bdc3c7;
                border-radius: 4px;
                font-size: 14px;
                min-width: 150px;
            }
            .puzzle-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
            }
            .puzzle-item {
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: grid;
                grid-template-columns: 200px 1fr auto;
                gap: 20px;
                align-items: center;
            }
            .puzzle-left {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .puzzle-id {
                font-weight: bold;
                color: #2c3e50;
            }
            .puzzle-id a {
                color: inherit;
                text-decoration: none;
                transition: color 0.2s;
            }
            .puzzle-id a:hover {
                color: #3498db;
                text-decoration: underline;
            }
            .puzzle-stats {
                color: #34495e;
                line-height: 1.4;
            }
            .puzzle-right {
                color: #7f8c8d;
                line-height: 1.4;
            }
            .difficulty {
                font-weight: bold;
            }
            .difficulty.easy {
                color: #27ae60;
            }
            .difficulty.medium {
                color: #2980b9;
            }
            .difficulty.hard {
                color: #e67e22;
            }
            .difficulty.expert {
                color: #c0392b;
            }
            .difficulty.unsolvable {
                color: #7f8c8d;
                font-style: italic;
            }
            .loading {
                text-align: center;
                padding: 20px;
                font-size: 1.2em;
                color: #666;
            }
            .save-button {
                background: #27ae60;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }
            .save-button:hover {
                background: #219a52;
            }
            .save-button.saved {
                background: #7f8c8d;
                cursor: default;
            }
            .save-button.unsolvable {
                background: #e74c3c;
                cursor: not-allowed;
            }
            .save-button.unsolvable:hover {
                background: #e74c3c;
            }
            .check-duplicates-button {
                background: #e74c3c;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }
            .check-duplicates-button:hover {
                background: #c0392b;
            }
            .duplicates-section {
                max-width: 800px;
                margin: 20px auto;
                padding: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: none;
            }
            .duplicates-section h2 {
                color: #2c3e50;
                margin-top: 0;
            }
            .duplicate-group {
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 4px;
            }
            .duplicate-group h3 {
                color: #e74c3c;
                margin-top: 0;
            }
            .duplicate-puzzle {
                margin: 5px 0;
                padding: 5px;
                background: white;
                border-radius: 4px;
            }
            .duplicate-puzzle a {
                color: #3498db;
                text-decoration: none;
            }
            .duplicate-puzzle a:hover {
                text-decoration: underline;
            }
        </style>
    </head>
    <body>
        <h1>Puzzle Analysis</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="grid-size">Grid Size:</label>
                <select id="grid-size">
                    <option value="6">6x6</option>
                    <option value="8">8x8</option>
                    <option value="10">10x10</option>
                </select>
            </div>
            <div class="control-group">
                <label for="puzzle-level">Puzzle Level:</label>
                <select id="puzzle-level">
                    <option value="1">Level 1</option>
                    <option value="2">Level 2</option>
                    <option value="3">Level 3</option>
                    <option value="4">Level 4</option>
                </select>
            </div>
            <span id="puzzle-stats" style="color: #2c3e50; font-weight: bold; display: inline-block;"></span>
            <button id="save-all-button" class="save-button">Save All Solvable</button>
            <button id="check-duplicates-button" class="check-duplicates-button">Check for Duplicates</button>
        </div>

        <div id="duplicates-section" class="duplicates-section">
            <h2>Duplicate Puzzles Found</h2>
            <div id="duplicates-content"></div>
        </div>

        <div id="puzzle-list" class="puzzle-list">
            <div class="loading">Loading puzzles...</div>
        </div>

        <!-- Load puzzle files -->
        <script src="puzzles/level 6x6 d1.js"></script>
        <script src="puzzles/level 6x6 d2.js"></script>
        <script src="puzzles/level 6x6 d3.js"></script>
        <script src="puzzles/level 6x6 d4.js"></script>
        <script src="puzzles/level 8x8 d1.js"></script>
        <script src="puzzles/level 8x8 d2.js"></script>
        <script src="puzzles/level 8x8 d3.js"></script>
        <script src="puzzles/level 8x8 d4.js"></script>
        <script src="puzzles/level 10x10 d1.js"></script>
        <script src="puzzles/level 10x10 d2.js"></script>
        <script src="puzzles/level 10x10 d3.js"></script>
        <script src="puzzles/level 10x10 d4.js"></script>
        <script src="puzzles/puzzles-loader.js"></script>

        <!-- Load game logic -->
        <script src="js/puzzle.js"></script>
        <script src="js/rules.js"></script>
        <script src="js/solver.js"></script>
        <script src="js/difficulty-calculator.js"></script>

        <script>
            // Store puzzle data globally
            let currentPuzzleData = [];
            let currentPuzzleItems = [];

            async function analyzePuzzles(size, level) {
                const puzzleList = document.getElementById('puzzle-list');
                const calculator = new DifficultyCalculator();
                const puzzleStats = document.getElementById('puzzle-stats');

                // Get puzzles for selected size and level
                const levelId = `level ${size}x${size} d${level}`;
                const puzzles = window.PuzzleLoader.getPuzzlesByLevel(levelId);
                
                // Clear loading message
                puzzleList.innerHTML = '';

                // Update page title
                document.querySelector('h1').textContent = `${size}x${size} Level ${level} Puzzle Analysis`;

                // First, analyze all puzzles
                currentPuzzleItems = [];
                currentPuzzleData = [];
                let unsolvablePuzzles = 0;
                let savablePuzzles = 0;

                puzzles.forEach((puzzle, index) => {
                    // Create puzzle instance
                    const puzzleInstance = new BinaryPuzzle(puzzle.size);
                    puzzleInstance.loadPuzzle(puzzle.grid);
                    
                    // Create solver
                    const solver = new BinarySolver(puzzleInstance);
                    
                    // Track steps
                    const steps = [];
                    const success = solver.solve(step => {
                        steps.push({
                            rule: step.rule
                        });
                    });

                    // Count steps by rule
                    const ruleCounts = {};
                    steps.forEach(step => {
                        ruleCounts[step.rule] = (ruleCounts[step.rule] || 0) + 1;
                    });

                    // Calculate missing cells
                    const totalCells = puzzle.size * puzzle.size;
                    const missingCells = puzzle.grid.flat().filter(cell => cell === null).length;
                    const missingPercentage = Math.round((missingCells / totalCells) * 100);

                    // Calculate difficulty
                    const difficulty = calculator.calculateDifficulty(
                        puzzle.size,
                        missingCells,
                        steps
                    );

                    // Create difficulty display
                    let difficultyDisplay;
                    if (success) {
                        difficultyDisplay = `<span class="difficulty ${difficulty.level.toLowerCase()}">${difficulty.score.toFixed(2)} (${difficulty.level})</span>`;
                        savablePuzzles++;
                        //console.log(`Puzzle ${puzzle.id} is solvable. Total solvable: ${savablePuzzles}`);
                    } else {
                        difficultyDisplay = `<span class="difficulty unsolvable">Unsolvable ==================================== </span>`;
                        unsolvablePuzzles++;
                        //console.log(`Puzzle ${puzzle.id} is unsolvable. Total unsolvable: ${unsolvablePuzzles}`);
                    }

                    // Create steps list
                    const simpleRules = ['pairs', 'equalnumber', 'sandwich'];
                    const complexRules = ['spreadantitriplet', 'quadantitriplet', 'clustered4emptycells', 'clustered5emptycells', 'duplicaterow2', 'duplicaterow3'];

                    const simpleSteps = Object.entries(ruleCounts)
                        .filter(([rule]) => simpleRules.includes(rule))
                        .map(([rule, count]) => `${count} ${rule.charAt(0).toUpperCase() + rule.slice(1)}`)
                        .join(' ');

                    const complexSteps = Object.entries(ruleCounts)
                        .filter(([rule]) => complexRules.includes(rule))
                        .map(([rule, count]) => `${count} ${rule.charAt(0).toUpperCase() + rule.slice(1)}`)
                        .join(' ');

                    // Create puzzle item
                    const puzzleItem = document.createElement('div');
                    puzzleItem.className = 'puzzle-item';
                    
                    // Prepare the data for the save button
                    const saveData = {
                        id: puzzle.id,
                        size: puzzle.size,
                        missing: missingCells,
                        difficulty: success ? difficulty.score : 0,
                        puzzle_array: puzzle.grid,
                        solution_array: puzzleInstance.grid,
                        solve_data: {
                            simple_rules: Object.fromEntries(Object.entries(ruleCounts).filter(([rule]) => simpleRules.includes(rule))),
                            complex_rules: Object.fromEntries(Object.entries(ruleCounts).filter(([rule]) => complexRules.includes(rule)))
                        }
                    };

                    puzzleItem.innerHTML = `
                        <div class="puzzle-left">
                            <div class="puzzle-id">
                                <a href="index.php?puzzle=${puzzle.id}" target="puzzle_window">${index + 1}. ${puzzle.id}</a>
                            </div>
                            <div class="puzzle-stats">
                                Missing: ${missingCells}/${totalCells} (${missingPercentage}%)
                            </div>
                        </div>
                        <div class="puzzle-right">
                            ${difficultyDisplay}<br>
                            ${simpleSteps}<br>
                            ${complexSteps}
                        </div>
                        <button class="save-button ${!success ? 'unsolvable' : ''}" data-puzzle='${JSON.stringify(saveData)}' ${!success ? 'disabled' : ''}>Save to DB</button>
                    `;

                    // Add click handler after creating the element
                    const saveButton = puzzleItem.querySelector('.save-button');
                    if (success) {  // Only add click handler for solvable puzzles
                        saveButton.addEventListener('click', function() {
                            const data = JSON.parse(this.dataset.puzzle);
                            savePuzzle(data, this);
                        });
                    } else {
                        saveButton.classList.add('saved');  // Style disabled button
                    }

                    puzzleList.appendChild(puzzleItem);
                    currentPuzzleItems.push(puzzleItem);
                    currentPuzzleData.push(saveData);
                });

                // Update initial puzzle stats (before DB check)
                puzzleStats.innerHTML = `checking DB...<br>${unsolvablePuzzles} unsolvable<br>${puzzles.length} total puzzles`;
                //console.log(`Initial stats - Solvable: ${savablePuzzles}, Unsolvable: ${unsolvablePuzzles}, Total: ${puzzles.length}`);

                // Check database status for all puzzles
                try {
                    //console.log('Sending puzzles to check:', currentPuzzleData.map(p => ({ id: p.id, size: p.size })));
                    const response = await fetch('check-puzzles.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ puzzles: currentPuzzleData })
                    });

                    const result = await response.json();
                    
                    if (response.ok && result.results) {
                        // Count how many puzzles can be saved (exist in DB)
                        let existingInDB = 0;
                        //console.log('Database check results:', result.results);
                        //console.log('Current puzzle data:', currentPuzzleData.map(p => p.id));
                        
                        currentPuzzleItems.forEach((item, index) => {
                            const button = item.querySelector('.save-button');
                            const puzzleId = currentPuzzleData[index].id;
                            const dbStatus = result.results[puzzleId];

                            if (dbStatus && dbStatus.exists) {
                                existingInDB++;
                                console.log(`Puzzle ${puzzleId} exists in DB with ID: ${dbStatus.db_id}, Name: ${dbStatus.puzzle_name}`);
                                if (dbStatus.has_duplicates) {
                                    console.log(`  - Has ${dbStatus.duplicate_count} copies in DB`);
                                    button.textContent = `Exists (ID: ${dbStatus.db_id}, ${dbStatus.duplicate_count} copies)`;
                                } else {
                                    button.textContent = `Exists (ID: ${dbStatus.db_id})`;
                                }
                                button.classList.add('saved');
                                button.disabled = true;
                            } else {
                                //console.log(`Puzzle ${puzzleId} does not exist in DB`);
                            }
                        });

                        // Update final puzzle stats
                        const canBeSaved = savablePuzzles - existingInDB;
                        console.log(`Final stats - Solvable: ${savablePuzzles}, Existing in DB: ${existingInDB}, Can be saved: ${canBeSaved}`);
                        puzzleStats.innerHTML = `${canBeSaved} can be saved<br>${unsolvablePuzzles} unsolvable<br>${puzzles.length} total puzzles`;
                    }
                } catch (error) {
                    console.error('Error checking puzzle status:', error);
                    puzzleStats.innerHTML = `error checking DB<br>${unsolvablePuzzles} unsolvable<br>${puzzles.length} total puzzles`;
                }
            }

            async function saveAllPuzzles() {
                const saveAllButton = document.getElementById('save-all-button');
                saveAllButton.disabled = true;
                saveAllButton.textContent = 'Saving...';

                let savedCount = 0;
                let skippedCount = 0;

                for (let i = 0; i < currentPuzzleData.length; i++) {
                    const button = currentPuzzleItems[i].querySelector('.save-button');
                    if (!button.disabled) {
                        try {
                            const response = await fetch('save-puzzle.php', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(currentPuzzleData[i])
                            });

                            const result = await response.json();
                            
                            if (response.ok) {
                                if (result.success) {
                                    button.textContent = `Saved (ID: ${result.id})`;
                                    savedCount++;
                                } else {
                                    button.textContent = `Exists (ID: ${result.existing_id})`;
                                    skippedCount++;
                                }
                                button.classList.add('saved');
                                button.disabled = true;
                            }
                        } catch (error) {
                            console.error('Error saving puzzle:', error);
                        }
                    }
                }

                saveAllButton.textContent = `Save All Solvable (${savedCount} saved, ${skippedCount} skipped)`;
                setTimeout(() => {
                    saveAllButton.textContent = 'Save All Solvable';
                    saveAllButton.disabled = false;
                }, 3000);
            }

            async function checkDuplicates() {
                const duplicatesSection = document.getElementById('duplicates-section');
                const duplicatesContent = document.getElementById('duplicates-content');
                const checkButton = document.getElementById('check-duplicates-button');
                
                checkButton.disabled = true;
                checkButton.textContent = 'Checking...';
                duplicatesSection.style.display = 'block';
                duplicatesContent.innerHTML = '<div class="loading">Checking for duplicates...</div>';
                
                try {
                    const response = await fetch('check-duplicates.php');
                    const result = await response.json();
                    
                    if (result.success) {
                        if (result.total_duplicates === 0) {
                            duplicatesContent.innerHTML = `<p>No duplicate puzzles found after checking ${result.total_puzzles_checked} puzzles.</p>`;
                        } else {
                            let html = `<p>Found ${result.total_duplicates} sets of duplicate puzzles after checking ${result.total_puzzles_checked} puzzles:</p>`;
                            
                            result.duplicates.forEach((group, index) => {
                                html += `
                                    <div class="duplicate-group">
                                        <h3>Duplicate Set ${index + 1}</h3>
                                        ${group.puzzles.map(puzzle => `
                                            <div class="duplicate-puzzle">
                                                <a href="index.php?puzzle=${puzzle.id}" target="puzzle_window">
                                                    ID: ${puzzle.id} - ${puzzle.name}
                                                </a>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            });
                            
                            duplicatesContent.innerHTML = html;
                        }
                    } else {
                        duplicatesContent.innerHTML = '<p>Error checking for duplicates: ' + (result.error || 'Unknown error') + '</p>';
                    }
                } catch (error) {
                    duplicatesContent.innerHTML = '<p>Error checking for duplicates: ' + error.message + '</p>';
                }
                
                checkButton.disabled = false;
                checkButton.textContent = 'Check for Duplicates';
            }

            document.addEventListener('DOMContentLoaded', () => {
                const gridSizeSelect = document.getElementById('grid-size');
                const puzzleLevelSelect = document.getElementById('puzzle-level');
                const saveAllButton = document.getElementById('save-all-button');
                const checkDuplicatesButton = document.getElementById('check-duplicates-button');

                // Set initial values
                gridSizeSelect.value = '6';
                puzzleLevelSelect.value = '1';

                // Add change event listeners
                gridSizeSelect.addEventListener('change', () => {
                    analyzePuzzles(gridSizeSelect.value, puzzleLevelSelect.value);
                });

                puzzleLevelSelect.addEventListener('change', () => {
                    analyzePuzzles(gridSizeSelect.value, puzzleLevelSelect.value);
                });

                // Add button listeners
                saveAllButton.addEventListener('click', saveAllPuzzles);
                checkDuplicatesButton.addEventListener('click', checkDuplicates);

                // Initial analysis
                analyzePuzzles('6', '1');
            });

            async function savePuzzle(data, button) {
                try {
                    const response = await fetch('save-puzzle.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        if (result.success) {
                            button.textContent = `Saved (ID: ${result.id})`;
                            button.classList.add('saved');
                            button.disabled = true;
                            console.log('Save successful:', result);
                        } else {
                            // Puzzle already exists
                            button.textContent = `Exists (ID: ${result.existing_id})`;
                            button.classList.add('saved');
                            button.disabled = true;
                            console.log('Puzzle already exists:', result);
                        }
                    } else {
                        console.error('Save failed:', result);
                        alert('Error saving puzzle: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving puzzle to database: ' + error.message);
                }
            }

            /**
             * Show a message in the message box
             * @param {string} message - The message to display
             * @param {string} type - The type of message (info, success, error)
             */
            function showMessage(message, type = 'info') {
                elements.messageBox.innerHTML = message;
                elements.messageBox.className = `message-box ${type}`;
                elements.messageBox.style.display = 'block';
            }
        </script>
    </body>
</html> 